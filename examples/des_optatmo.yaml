# Copyright (c) 2016 by Mike Jarvis and the other collaborators on GitHub at
# https://github.com/rmjarvis/Piff  All rights reserved.
#
# Piff is free software: Redistribution and use in source and binary forms
# with or without modification, are permitted provided that the following
# conditions are met:
#
# 1. Redistributions of source code must retain the above copyright notice, this
#    list of conditions and the disclaimer given in the accompanying LICENSE
#    file.
# 2. Redistributions in binary form must reproduce the above copyright notice,
#    this list of conditions and the disclaimer given in the documentation
#    and/or other materials provided with the distribution.


# This config file will run through a full DES field of view and produce a Piff PSF solution
# file along with a could stats images.

input:

    # must specify in advance.
    # TODO: currently do not know how to create a list to get all the ccds
    # nimages: 5
    image_file_name: '/nfs/slac/g/ki/ki18/cpd/Projects/DES/Piff/tests/y1_test_dir/DECam_*_??.fits.fz'
    cat_file_name:
        type: Eval
        str: "image_file_name.replace('.fits.fz', '_psfcat_tb_maxmag_17.0_magcut_3.0_findstars.fits')"
        simage_file_name: '@input.image_file_name'

    # What hdu is everything in?
    image_hdu: 1
    badpix_hdu: 2
    weight_hdu: 3
    cat_hdu: 2

    # What columns in the catalog have things we need?
    x_col: XWIN_IMAGE
    y_col: YWIN_IMAGE
    ra: TELRA
    dec: TELDEC
    gain: GAINA
    sky_col: BACKGROUND

    # How large should the postage stamp cutouts of the stars be?
    stamp_size: 31

    # use only some stars per ccd
    nstars: 100
    # cut poorly measured stars
    min_snr: 20
    # limit star snr so we don't weight bright stars
    max_snr: 100

psf:

    # combine the optical and atmosphere psfs together
    type: OptAtmo

    optpsf:
        type: OpticalWavefront

        # where the knn file lives
        knn_file_name: /nfs/slac/g/ki/ki18/cpd/Projects/DES/Piff/tests/wavefront_test/Science-20121120s1-v20i2_noextname.fits

        knn_extname: 1

        # maximum number of steps to take
        max_iterations: 300

        # if > 0, number of stars to use in fit
        n_fit_stars: 0

        # fudge factor in chi square until we fix errors in hsm
        error_estimate: 0.001

        engine: 'galsim_fast'

        template: 'des'

        # ['minuit', or 'lmfit']
        fitter_algorithm: 'minuit'

        fitter_kwargs:
            fix_r0: False
            fix_g1: False
            fix_g2: False
            fix_z04d: False
            fix_z05d: False
            fix_z06d: False
            fix_z07d: False
            fix_z08d: False
            fix_z09d: False
            fix_z10d: False
            fix_z11d: True
            fix_z04x: True
            fix_z05x: True
            fix_z06x: True
            fix_z07x: False
            fix_z08x: False
            fix_z09x: True
            fix_z10x: True
            fix_z11x: True
            fix_z04y: True
            fix_z05y: True
            fix_z06y: True
            fix_z07y: False
            fix_z08y: False
            fix_z09y: True
            fix_z10y: True
            fix_z11y: True

    atmopsf:
        # This type of PSF will use a separate model/interp solution for each chip.
        type: SingleChip

        # outliers:

        #     # This does outlier rejection based on the chisq value of the residual of the
        #     # interpolated star with the original.
        #     type: Chisq

        #     # The threshold is given in terms of nsigma equivalent, since that's how we normally
        #     # think of this, but really this is based on the chisq probability distribution for the
        #     # number of degrees of freedom the model has.
        #     nsigma: 4

        #     # Only remove at most 3 stars per iteration.
        #     max_remove: 3

        model:

            # Gaussian
            type: Gaussian
            include_pixel: False
            fastfit: True

        interp:

            type: Polynomial
            order: 2

output:

    # The output directory is by default the same as the input, but can specify a different one.
    dir: output
    file_name: "DECam_00241238.piff"

    stats:

        # Multiple output statistics can be listed in a list
        -
            type: ShapeHistograms
            file_name: "DECam_00241238_shapes.png"
            bins_size: 100
            bins_shape: 100

        -
            type: Rho
            file_name: "DECam_00241238_rho.png"
            # Rho can use any config parameters used by TreeCorr for doing the correlation.
            min_sep: 0.5
            max_sep: 300
            sep_units: arcmin
            bin_size: 0.5

        -
            type: TwoDHist
            file_name: "DECam_00241238_twodhist.png"
            number_bins_u: 20
            number_bins_v: 20

# Set the verbosity level a little higher than default (1) to give extra information
# about the progress.
verbose: 2
